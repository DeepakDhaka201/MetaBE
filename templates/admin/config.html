{% extends "admin/base.html" %}

{% block title %}System Configuration - MetaX Admin{% endblock %}

{% block page_title %}System Configuration{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button type="button" class="btn btn-outline-primary" onclick="location.reload()">
        <i class="fas fa-sync-alt me-1"></i>Refresh
    </button>
    <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addConfigModal">
        <i class="fas fa-plus me-1"></i>Add Configuration
    </button>
    <button type="button" class="btn btn-outline-warning" onclick="resetToDefaults()">
        <i class="fas fa-undo me-1"></i>Reset to Defaults
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Category Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <label for="categoryFilter" class="form-label">Filter by Category</label>
                <select class="form-select" id="categoryFilter" onchange="filterByCategory()">
                    <option value="all" {{ 'selected' if selected_category == 'all' else '' }}>All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category }}" {{ 'selected' if selected_category == category else '' }}>
                        {{ category.title() }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label for="searchConfig" class="form-label">Search Configurations</label>
                <input type="text" class="form-control" id="searchConfig" placeholder="Search by key or description..." onkeyup="searchConfigs()">
            </div>
        </div>
    </div>
</div>

<!-- Configuration Groups -->
{% for category, configs in config_groups.items() %}
<div class="card mb-4 config-category" data-category="{{ category }}">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-{{ 'dollar-sign' if category == 'transaction' else 'users' if category == 'referral' else 'shield-alt' if category == 'security' else 'cogs' }} me-2"></i>
            {{ category.title() }} Settings
        </h5>
        <span class="badge bg-primary">{{ configs|length }} items</span>
    </div>
    <div class="card-body">
        <form id="configForm{{ category }}" class="config-form">
            <div class="row">
                {% for config in configs %}
                <div class="col-lg-6 mb-3 config-item" data-key="{{ config.key }}" data-description="{{ config.description or '' }}">
                    <label for="{{ config.key }}" class="form-label">
                        {{ config.key.replace('_', ' ').title() }}
                        {% if config.description %}
                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="{{ config.description }}"></i>
                        {% endif %}
                    </label>
                    
                    {% if config.data_type == 'boolean' %}
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="{{ config.key }}" name="{{ config.key }}" 
                               {{ 'checked' if config.get_value() else '' }}>
                        <label class="form-check-label" for="{{ config.key }}">
                            {{ 'Enabled' if config.get_value() else 'Disabled' }}
                        </label>
                    </div>
                    
                    {% elif config.data_type == 'json' %}
                    <textarea class="form-control font-monospace" id="{{ config.key }}" name="{{ config.key }}" 
                              rows="4" placeholder="Enter JSON data...">{{ config.value }}</textarea>
                    <div class="form-text">JSON format required</div>
                    
                    {% elif config.data_type == 'number' %}
                    <input type="number" class="form-control" id="{{ config.key }}" name="{{ config.key }}" 
                           value="{{ config.get_value() }}" step="0.01">
                    
                    {% else %}
                    <input type="text" class="form-control" id="{{ config.key }}" name="{{ config.key }}" 
                           value="{{ config.get_value() }}">
                    {% endif %}
                    
                    <div class="form-text">
                        <small class="text-muted">
                            Last updated: {{ config.updated_at.strftime('%m/%d/%Y %H:%M') if config.updated_at else 'Never' }}
                            {% if config.updater %}
                            by {{ config.updater.username }}
                            {% endif %}
                        </small>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="text-end mt-3">
                <button type="button" class="btn btn-outline-secondary" onclick="resetCategory('{{ category }}')">
                    <i class="fas fa-undo me-1"></i>Reset
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Save {{ category.title() }} Settings
                </button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

{% if not config_groups %}
<div class="card">
    <div class="card-body text-center text-muted py-5">
        <i class="fas fa-cogs fa-3x mb-3"></i>
        <h5>No Configurations Found</h5>
        <p>No system configurations are available.</p>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
            <i class="fas fa-plus me-1"></i>Add First Configuration
        </button>
    </div>
</div>
{% endif %}

<!-- Add Configuration Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addConfigForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newConfigKey" class="form-label">Configuration Key</label>
                        <input type="text" class="form-control" id="newConfigKey" name="key" required
                               pattern="[a-z_]+" title="Use lowercase letters and underscores only">
                        <div class="form-text">Use lowercase letters and underscores (e.g., max_withdrawal_amount)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newConfigValue" class="form-label">Value</label>
                        <input type="text" class="form-control" id="newConfigValue" name="value" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newConfigDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="newConfigDescription" name="description" rows="2"
                                  placeholder="Brief description of what this configuration controls..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newConfigCategory" class="form-label">Category</label>
                        <select class="form-select" id="newConfigCategory" name="category" required>
                            <option value="">Select Category</option>
                            <option value="general">General</option>
                            <option value="transaction">Transaction</option>
                            <option value="referral">Referral</option>
                            <option value="security">Security</option>
                            <option value="notification">Notification</option>
                            <option value="api">API</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="newConfigDataType" class="form-label">Data Type</label>
                        <select class="form-select" id="newConfigDataType" name="data_type" required>
                            <option value="string">String</option>
                            <option value="number">Number</option>
                            <option value="boolean">Boolean</option>
                            <option value="json">JSON</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="newConfigIsPublic" name="is_public">
                        <label class="form-check-label" for="newConfigIsPublic">
                            Make this configuration public (visible to users)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Configuration
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Backup/Restore Modal -->
<div class="modal fade" id="backupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Backup & Restore</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Backup Configuration</h6>
                        <p class="text-muted">Download current configuration as JSON file</p>
                        <button type="button" class="btn btn-outline-primary w-100" onclick="downloadBackup()">
                            <i class="fas fa-download me-1"></i>Download Backup
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Restore Configuration</h6>
                        <p class="text-muted">Upload and restore from backup file</p>
                        <input type="file" class="form-control mb-2" id="restoreFile" accept=".json">
                        <button type="button" class="btn btn-outline-warning w-100" onclick="restoreBackup()">
                            <i class="fas fa-upload me-1"></i>Restore Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.config-item {
    transition: all 0.3s ease;
}

.config-item.highlight {
    background-color: rgba(255, 193, 7, 0.1);
    border-radius: 5px;
    padding: 10px;
}

.font-monospace {
    font-family: 'Courier New', monospace;
}

.form-check-input:checked + .form-check-label::after {
    content: " ✓";
    color: #28a745;
    font-weight: bold;
}

.config-category.hidden {
    display: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Initialize tooltips
$(document).ready(function() {
    $('[data-bs-toggle="tooltip"]').tooltip();
});

// Handle configuration form submissions
$('.config-form').on('submit', function(e) {
    e.preventDefault();

    const form = $(this);
    const formData = new FormData(this);
    const data = {};

    // Process form data
    for (let [key, value] of formData.entries()) {
        const input = form.find(`[name="${key}"]`);

        if (input.attr('type') === 'checkbox') {
            data[key] = input.is(':checked');
        } else {
            data[key] = value;
        }
    }

    $.ajax({
        url: '/admin/api/config',
        method: 'PUT',
        headers: {
            'Authorization': 'Bearer ' + getAdminToken(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                // Update last modified timestamps
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(response.message, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showAlert(response?.message || 'An error occurred', 'danger');
        }
    });
});

// Handle add configuration form
$('#addConfigForm').on('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = Object.fromEntries(formData);

    // Convert checkbox to boolean
    data.is_public = formData.has('is_public');

    $.ajax({
        url: '/admin/api/config',
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getAdminToken(),
            'Content-Type': 'application/json'
        },
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addConfigModal'));
                modal.hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                showAlert(response.message, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            showAlert(response?.message || 'An error occurred', 'danger');
        }
    });
});

function filterByCategory() {
    const selectedCategory = document.getElementById('categoryFilter').value;
    const categories = document.querySelectorAll('.config-category');

    categories.forEach(category => {
        if (selectedCategory === 'all' || category.dataset.category === selectedCategory) {
            category.classList.remove('hidden');
        } else {
            category.classList.add('hidden');
        }
    });

    // Update URL without page reload
    const url = new URL(window.location);
    url.searchParams.set('category', selectedCategory);
    window.history.pushState({}, '', url);
}

function searchConfigs() {
    const searchTerm = document.getElementById('searchConfig').value.toLowerCase();
    const configItems = document.querySelectorAll('.config-item');

    configItems.forEach(item => {
        const key = item.dataset.key.toLowerCase();
        const description = item.dataset.description.toLowerCase();

        if (key.includes(searchTerm) || description.includes(searchTerm)) {
            item.style.display = 'block';
            item.classList.add('highlight');
        } else {
            item.style.display = searchTerm ? 'none' : 'block';
            item.classList.remove('highlight');
        }
    });
}

function resetToDefaults() {
    if (confirm('Are you sure you want to reset ALL configurations to their default values? This action cannot be undone.')) {
        $.ajax({
            url: '/admin/api/config/reset',
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getAdminToken()
            },
            success: function(response) {
                if (response.success) {
                    showAlert(response.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showAlert(response.message, 'danger');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert(response?.message || 'An error occurred', 'danger');
            }
        });
    }
}
</script>
{% endblock %}
